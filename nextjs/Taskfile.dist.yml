# https://taskfile.dev

version: '3'

includes:
  util:
    taskfile: ../Taskfile.util.yml
    internal: true

vars:
  NEXTJS_PORT: 13030
  STORYBOOK_PORT: 6006
  PRETTIER_GLOB: "./**/*.{js,jsx,ts,tsx,css,scss,json}"

tasks:
  default:
    desc: List available tasks.
    aliases: [ls, list]
    silent: true
    cmds:
      - task: util:list

  ######################## ðŸ”§ DEV COMMANDS ðŸ”§ ########################
  ################# ðŸ”§ Commands you'll use OFTEN. ðŸ”§ #################

  install:
    desc: Install client dependencies.
    aliases: [i]
    deps: [util:trove-configure-codeartifact]
    sources:
      - ./package*.json
    generates:
      - ./node_modules/**/*
    cmds:
      # Ignore confusing pre/post install scripts in package.json
      - npm install --ignore-scripts

  dev:
    desc: Build and watch the client code.
    aliases: [watch, w]
    cmds:
      - npx next dev --port {{.NEXTJS_PORT}}

  ######################### ðŸ”§ custom tasks ðŸ”§ ########################

  # Add any custom DEV COMMANDS tasks here.

  ######################## ðŸ“¦ INSTALL/BUILD ðŸ“¦ #######################
  ############## ðŸ“¦ Commands for creating the client. ðŸ“¦ #############

  build:
    summary: Build the client code.
    cmds:
      - npx next build

  start:
    summary: Start the production server.
    cmds:
      - npx next start

  ######################### ðŸ“¦ custom tasks ðŸ“¦ ########################

  # Add any custom INSTALL/BUILD tasks here.

  ########################### ðŸ§¹ LINTING ðŸ§¹ ###########################
  ######## ðŸ§¹ Commands for checking and cleaning the code. ðŸ§¹ #########

  check:
    desc: Check the client code.
    aliases: [c]
    # Runs all checks in parallel.
    deps: [format-check, lint, ts-check, test]

  format:
    summary: Prettify the client code.
    aliases: [p, pretty, pretty-all]
    cmds:
      - npx prettier "{{.PRETTIER_GLOB}}" --write

  format-check:
    summary: Check the client code for prettier violations.
    aliases: [pretty-check]
    cmds:
      - npx prettier "{{.PRETTIER_GLOB}}" --check

  lint:
    summary: Lint the client code.
    cmds:
      - npx next lint

  ts-check:
    summary: Type check the client code.
    aliases: [ts, tsc]
    cmds:
      - npx tsc

  ######################### ðŸ§¹ custom tasks ðŸ§¹ ########################

  # Add any custom LINTING tasks here.

  ########################### ðŸ§ª TESTING ðŸ§ª ###########################
  ################# ðŸ§ª Commands for running tests. ðŸ§ª #################

  test:
    desc: Run all client tests.
    cmds:
      - npx jest

  test-watch:
    summary: Run client tests in watch mode.
    cmds:
      - npx jest --watch

  ######################### ðŸ§ª custom tasks ðŸ§ª ########################

  # Add any custom TESTING tasks here.

  ########################### ðŸ§° UTILITY ðŸ§° ###########################
  ############### ðŸ§° Commands you'll use SOMETIMES. ðŸ§° ################

  # TODO: add analyze task in

  storybook:
    summary: Start the Storybook development server.
    cmds:
      - cmd: npx storybook dev -p {{.STORYBOOK_PORT}}
        ignore_error: true  # ignore red error line on kill watch process

  build-storybook:
    summary: Build the Storybook static site.
    cmds:
      - npx storybook build

  ######################### ðŸ§° custom tasks ðŸ§° ########################

  # Add any custom UTILITY tasks here.
